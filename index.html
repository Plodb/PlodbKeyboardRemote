<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PlodbKeyboardRemote</title>
  <link rel="icon" href="data:image/png;base64,{ICON_BASE64}">
  <style>
    .key-tab {
      flex: 1.5;
    }

    .key-capslock {
      flex: 1.75;
    }

    .key-backspace {
      flex: 2;
    }

    .key-enter {
      flex: 2.25;
    }

    .key-shift {
      flex: 2.25;
    }

    .key-space {
      flex-grow: 6;
      flex-basis: 0;
    }

    .key-ctrl,
    .key-alt {
      flex: 1.25;
    }

    body {
      background: #fed7e9;
      margin: 0;
      font-family: monospace;
      justify-content: center;
      display: flex;
      width: 100vw;
      height: fit-content;
      overflow: hidden;
    }

    #keyboard {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 1rem;
      margin: 1rem;
      border-radius: 14px;
      background-color: white;
      height: fit-content;
      width: 100%;
    }

    .row {
      display: flex;
      gap: 6px;
    }

    button {
      flex: 1;
      padding: 6px 10px;
      font-size: 1.5vw;
      background: #fd9bca;
      color: #fff;
      border: #fc69b0 solid;
      border-radius: 5px;
      user-select: none;
      touch-action: manipulation;
      transition: all 0.1s ease;
    }

    button.spacebar {
      flex-grow: 6;
      flex-basis: 0;
    }

    button.pressed {
      background: #9bfdce !important;
      color: #111 !important;
      font-weight: bold;
      transform: scale(1.05);
    }

    button.held {
      background: #9bfdce !important;
      color: #111 !important;
      font-weight: bold;
      transform: scale(1.05);
    }
  </style>
</head>

<body>
  <button id="lang-switch" class="utility-button">üåê Lang</button>
  <div id="keyboard"></div>

  <script>
    let currentLayout = [];
    let currentLayoutName = "en";

    const container = document.getElementById("keyboard");
    const toggled = new Set();
    const keyStates = new Map();
    let ws = null;

    const layout_en = [
      ["esc", "f1", "f2", "f3", "f4", "f5", "f6", "f7", "f8", "f9", "f10", "f11", "f12"],
      ["`", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "backspace"],
      ["tab", "q", "w", "e", "r", "t", "y", "u", "i", "o", "p", "[", "]", "\\"],
      ["!", "a", "s", "d", "f", "g", "h", "j", "k", "l", ";", "'", "enter"],
      ["shift", "z", "x", "c", "v", "b", "n", "m", ",", ".", "/", "up", "?", "shift"],
      ["ctrl", "alt", "space", "alt", "ctrl", "left", "down", "right"]
    ];

    const layout_ru = [
      ["esc", "f1", "f2", "f3", "f4", "f5", "f6", "f7", "f8", "f9", "f10", "f11", "f12"],
      ["—ë", "1", "2", "3", "4", "5", "6", "7", "8", "9", "0", "-", "=", "backspace"],
      ["tab", "–π", "—Ü", "—É", "–∫", "–µ", "–Ω", "–≥", "—à", "—â", "–∑", "—Ö", "—ä", "\\"],
      ["!", "—Ñ", "—ã", "–≤", "–∞", "–ø", "—Ä", "–æ", "–ª", "–¥", "–∂", "—ç", "enter"],
      ["shift", "—è", "—á", "—Å", "–º", "–∏", "—Ç", "—å", "–±", "—é", ".", "up", "?", "shift"],
      ["ctrl", "alt", "space", "alt", "ctrl", "left", "down", "right"]
    ];

    const ruToEnMap = {
      "—ë": "`", "–π": "q", "—Ü": "w", "—É": "e", "–∫": "r", "–µ": "t", "–Ω": "y", "–≥": "u",
      "—à": "i", "—â": "o", "–∑": "p", "—Ö": "[", "—ä": "]", "—Ñ": "a", "—ã": "s", "–≤": "d",
      "–∞": "f", "–ø": "g", "—Ä": "h", "–æ": "j", "–ª": "k", "–¥": "l", "–∂": ";", "—ç": "'",
      "—è": "z", "—á": "x", "—Å": "c", "–º": "v", "–∏": "b", "—Ç": "n", "—å": "m",
      "–±": ",", "—é": ".", ".": "/"
    };

    function toPhysical(key) {
      return currentLayoutName === "ru" && ruToEnMap[key] ? ruToEnMap[key] : key;
    }

    function renderKeyboard() {
      container.innerHTML = "";

      const sizeClass = {
        tab: "key-tab",
        capslock: "key-capslock",
        "1111111!!!!!!": "key-capslock",
        backspace: "key-backspace",
        enter: "key-enter",
        shift: "key-shift",
        space: "key-space",
        ctrl: "key-ctrl",
        alt: "key-alt"
      };

      currentLayout.forEach(row => {
        const rowEl = document.createElement("div");
        rowEl.className = "row";

        row.forEach(key => {
          if (key === "") {
            const spacer = document.createElement("div");
            spacer.style.flex = "1";
            spacer.style.visibility = "hidden";
            rowEl.appendChild(spacer);
            return;
          }

          const btn = document.createElement("button");
          btn.innerText = key.length === 1 || key === "1111111!!!!!!" ? key.toUpperCase() : key;
          btn.dataset.key = key;

          if (sizeClass[key]) btn.classList.add(sizeClass[key]);

          setupEvents(btn, key);
          rowEl.appendChild(btn);
        });

        container.appendChild(rowEl);
      });

      updateButtonStyles();
    }

    function setupEvents(btn, key) {
      let tapTimeout = null;
      let lastTap = 0;

      btn.onpointerdown = () => {
        const physical = toPhysical(key);
        keyStates.set(key, "pressed");
        updateButtonStyles();

        if (["alt", "ctrl", "shift"].includes(key)) {
          const now = Date.now();
          if (now - lastTap < 300) {
            if (toggled.has(key)) {
              toggled.delete(key);
              ws.send(JSON.stringify({ type: "keyup", key: physical }));
            } else {
              toggled.add(key);
              ws.send(JSON.stringify({ type: "keydown", key: physical }));
            }
            lastTap = 0;
            updateButtonStyles();
            return;
          }
          lastTap = now;
          ws.send(JSON.stringify({ type: "keydown", key: physical }));
        } else if (key === "capslock") {
          // handled in interval
        } else {
          ws.send(JSON.stringify({ type: "keydown", key: physical }));
        }
      };

      btn.onpointerup = () => {
        const physical = toPhysical(key);
        keyStates.delete(key);
        if (!toggled.has(key) && key !== "capslock") {
          ws.send(JSON.stringify({ type: "keyup", key: physical }));
        }
        updateButtonStyles();
      };

      btn.onpointerleave = () => {
        if (keyStates.get(key) === "pressed") {
          btn.onpointerup();
        }
      };
    }

    function updateButtonStyles() {
      document.querySelectorAll("button[data-key]").forEach(btn => {
        const key = btn.dataset.key;

        if (key === "capslock") {
          const isCaps = navigator.getModifierState && navigator.getModifierState("CapsLock");
          btn.classList.toggle("held", isCaps);
          btn.classList.remove("pressed");
        } else {
          const held = toggled.has(key);
          const pressed = keyStates.get(key) === "pressed";

          btn.classList.toggle("pressed", pressed && !held);
          btn.classList.toggle("held", held && !pressed);
          if (!pressed && !held) {
            btn.classList.remove("pressed", "held");
          }
        }
      });
    }

    function connectWS() {
      ws = new WebSocket("ws://" + location.hostname + ":8765");

      ws.onopen = () => {
        let pin = prompt("Enter PIN to connect:");
        if (pin) ws.send(JSON.stringify({ type: "pin", pin }));
      };

      ws.onmessage = event => {
        const data = JSON.parse(event.data);
        if (data.type === "pin_required") {
          alert("Wrong PIN");
        }
        if (data.type === "pin_accepted") {
          console.log("Connected");
        }
        if (data.type === "sync") {
          currentLayoutName = data.layout;
          currentLayout = currentLayoutName === "ru" ? layout_ru : layout_en;
          renderKeyboard();
        }
        if (data.type === "keyup") {
          const key = data.key;
          toggled.delete(key);
          keyStates.delete(key);
          updateButtonStyles();
        }
      };

      ws.onclose = () => {
        alert("WebSocket closed");
      };
    }

    document.getElementById("lang-switch").onclick = () => {
      const alt = "Alt", shift = "Shift";
      ws.send(JSON.stringify({ type: "keydown", key: alt }));
      setTimeout(() => ws.send(JSON.stringify({ type: "keydown", key: shift })), 100);
      setTimeout(() => ws.send(JSON.stringify({ type: "keyup", key: shift })), 150);
      setTimeout(() => ws.send(JSON.stringify({ type: "keyup", key: alt })), 200);
      setTimeout(() => ws.send(JSON.stringify({ type: "get_lang" })), 300);
    };

    window.addEventListener("blur", () => {
      for (const key of toggled) ws.send(JSON.stringify({ type: "keyup", key: toPhysical(key) }));
      toggled.clear();
      keyStates.clear();
      updateButtonStyles();
    });

    document.addEventListener("visibilitychange", () => {
      if (document.hidden) {
        for (const key of toggled) ws.send(JSON.stringify({ type: "keyup", key: toPhysical(key) }));
        toggled.clear();
        keyStates.clear();
        updateButtonStyles();
      }
    });

    let lastCapsState = null;
    setInterval(() => {
      const caps = document.querySelector('button[data-key="capslock"]');
      if (!caps || !navigator.getModifierState) return;
      const state = navigator.getModifierState("CapsLock");
      if (state !== lastCapsState) {
        caps.classList.toggle("held", state);
        lastCapsState = state;
      }
    }, 200);

    currentLayout = layout_en;
    renderKeyboard();
    connectWS();
  </script>
</body>

</html>